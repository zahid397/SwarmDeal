---
/**
 * ChatBox.astro
 * AI Negotiator Chat (Client Side)
 */
---

<div class="card chat-box" client:load>
  <div class="chat-header">
    <div style="display:flex; align-items:center; gap:10px;">
      <div class="bot-avatar">ü§ñ</div>
      <div>
        <h3 style="margin:0; font-size:1rem;">AI Negotiator</h3>
        <span style="font-size:.75rem; color:var(--accent); font-weight:600;">
          ‚óè Online & Ready
        </span>
      </div>
    </div>
  </div>

  <div id="chat-history" class="chat-history">
    <div class="msg ai">
      <strong>Hello!</strong> üëã <br />
      I can find the best group discounts for you.
      Click a suggestion below or type your wish!
    </div>
  </div>

  <div
    id="typing-indicator"
    class="typing-indicator"
    style="display:none;"
  >
    <span>‚óè</span><span>‚óè</span><span>‚óè</span>
    AI is negotiating...
  </div>

  <div class="quick-actions">
    <button class="chip" data-query="I want a MacBook Pro with 5 people">
      üíª MacBook Pro
    </button>
    <button class="chip" data-query="I need an iPhone 15 group deal">
      üì± iPhone 15
    </button>
    <button class="chip" data-query="Nike Air Jordan bulk buy">
      üëü Nike Shoes
    </button>
  </div>

  <div class="input-area">
    <input
      type="text"
      id="chat-input"
      placeholder="Type your wish here..."
      autocomplete="off"
    />
    <button id="send-btn">Send</button>
  </div>
</div>

<style>
  .bot-avatar {
    width: 35px;
    height: 35px;
    background: #eff6ff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
  }

  .quick-actions {
    display: flex;
    gap: 8px;
    padding: 0 1rem 1rem;
    overflow-x: auto;
    white-space: nowrap;
    scrollbar-width: none;
  }

  .chip {
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: 0.2s;
    font-weight: 500;
  }

  .chip:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  .typing-indicator {
    padding: 0 1.5rem 1rem;
    font-size: 0.8rem;
    color: var(--text-muted);
    display: flex;
    gap: 4px;
    align-items: center;
  }

  .typing-indicator span {
    animation: blink 1.4s infinite both;
    font-size: 1.2rem;
  }

  .typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
  }

  .typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes blink {
    0% { opacity: 0.2; }
    20% { opacity: 1; }
    100% { opacity: 0.2; }
  }
</style>

<script type="module">
  import { api } from "../utils/api.js";

  const input = document.getElementById("chat-input");
  const btn = document.getElementById("send-btn");
  const history = document.getElementById("chat-history");
  const typing = document.getElementById("typing-indicator");
  const chips = document.querySelectorAll(".chip");

  let messages = [];

  // üß™ DEMO FALLBACK DEALS (Hackathon Safe)
  const DEMO_DEALS = {
    macbook: {
      productName: "MacBook Pro M3",
      category: "Electronics",
      price: 1499,
      targetMembers: 5,
    },
    iphone: {
      productName: "iPhone 15 Pro",
      category: "Mobile",
      price: 999,
      targetMembers: 10,
    },
    nike: {
      productName: "Nike Air Jordan 1",
      category: "Fashion",
      price: 120,
      targetMembers: 20,
    },
  };

  async function sendMessage(customText = null) {
    const text = customText || input.value.trim();
    if (!text) return;

    appendMsg(text, "user");
    input.value = "";

    btn.disabled = true;
    typing.style.display = "flex";

    try {
      const res = await api.post("/ai/chat", {
        message: text,
        address: "guest_user",
        context: messages.slice(-5),
      });

      typing.style.display = "none";
      appendMsg(res.data.response, "ai");

      if (res.data.deal) {
        window.dispatchEvent(
          new CustomEvent("deal-found", { detail: res.data.deal })
        );
      }
    } catch (err) {
      console.warn("Backend sleeping, using demo deal");

      typing.style.display = "none";

      const t = text.toLowerCase();
      let deal = null;

      if (t.includes("macbook")) deal = DEMO_DEALS.macbook;
      else if (t.includes("iphone")) deal = DEMO_DEALS.iphone;
      else if (t.includes("nike") || t.includes("shoe"))
        deal = DEMO_DEALS.nike;

      if (deal) {
        appendMsg(
          `üöÄ I found a live deal for <strong>${deal.productName}</strong>. Check the card on the left!`,
          "ai"
        );
        window.dispatchEvent(
          new CustomEvent("deal-found", { detail: deal })
        );
      } else {
        appendMsg(
          "ü§ñ AI warming up... Try clicking one of the suggestions above!",
          "ai"
        );
      }
    } finally {
      btn.disabled = false;
      input.focus();
    }
  }

  function appendMsg(text, role) {
    const div = document.createElement("div");
    div.className = `msg ${role}`;
    div.innerHTML = text;
    history.appendChild(div);
    history.scrollTop = history.scrollHeight;
    messages.push({ role, content: text });
  }

  btn.addEventListener("click", () => sendMessage());
  input.addEventListener("keydown", (e) => e.key === "Enter" && sendMessage());

  chips.forEach((chip) => {
    chip.addEventListener("click", () => {
      sendMessage(chip.dataset.query);
    });
  });
</script>
