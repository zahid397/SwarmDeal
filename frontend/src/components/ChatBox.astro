<div class="card chat-box">
  <div class="chat-header">
    <div style="display: flex; align-items: center; gap: 10px;">
      <span style="font-size: 1.5rem;">ğŸ¤–</span>
      <div>
        <h3 style="margin: 0; font-size: 1rem;">AI Negotiator</h3>
        <span style="font-size: 0.8rem; color: var(--accent); font-weight: 600;">â— Online</span>
      </div>
    </div>
  </div>
  
  <div id="chat-history" class="chat-history">
    <div class="msg ai">
      <strong>Hello!</strong> ğŸ‘‹ <br>
      I can help you create a group deal. Try saying: <br>
      <em>"I want a MacBook Pro with 5 people"</em>
    </div>
  </div>

  <div class="input-area">
    <input type="text" id="chat-input" placeholder="Type your wish here..." autocomplete="off" />
    <button id="send-btn">Send</button>
  </div>
</div>

<script>
  import { api } from '../utils/api.js';

  const input = document.getElementById('chat-input');
  const btn = document.getElementById('send-btn');
  const history = document.getElementById('chat-history');
  let messages = [];

  async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    // UI Update
    appendMsg(text, 'user');
    input.value = '';
    btn.innerText = '...';
    btn.disabled = true;

    try {
      // API Call
      const res = await api.post('/ai/chat', { 
        message: text,
        address: 'guest_user',
        context: messages.slice(-5)
      });

      appendMsg(res.data.response, 'ai');

      // ğŸ”¥ Deal Trigger
      if (res.data.deal) {
        window.dispatchEvent(new CustomEvent('deal-found', { detail: res.data.deal }));
      }
    } catch (e) {
      console.error(e);
      // ğŸ”¥ SMART ERROR MESSAGE FOR HACKATHON
      appendMsg("ğŸ¤– AI is warming up from sleep mode (Render Free Tier)... please try again in 10 seconds! â˜•", 'ai');
    } finally {
      btn.innerText = 'Send';
      btn.disabled = false;
      input.focus();
    }
  }

  function appendMsg(text, role) {
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    div.innerHTML = text;
    history.appendChild(div);
    history.scrollTop = history.scrollHeight;
    messages.push({ role, content: text });
  }

  btn.addEventListener('click', sendMessage);
  input.addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());
</script>
