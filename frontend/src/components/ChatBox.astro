<div class="card chat-box">
  <div class="header">
    <div class="avatar">ü§ñ</div>
    <div>
      <h3>AI Negotiator</h3>
      <span class="status">‚óè Active</span>
    </div>
  </div>

  <div id="chat-history" class="history">
    <div class="msg ai">
      Hello! üëã I can help you find group deals.<br>
      Try: <strong>"MacBook Pro for 5 people"</strong>
    </div>
  </div>

  <div id="typing" class="typing" style="display: none;">
    <span>‚Ä¢</span><span>‚Ä¢</span><span>‚Ä¢</span> AI is negotiating...
  </div>

  <div class="chips">
    <button class="chip" data-q="MacBook Pro M3 bulk deal">üíª MacBook</button>
    <button class="chip" data-q="iPhone 15 Pro deal">üì± iPhone</button>
  </div>

  <div class="input-area">
    <input type="text" id="chat-input" placeholder="Type your wish..." autocomplete="off">
    <button id="send-btn">Send</button>
  </div>
</div>

<style>
  /* ‚úÖ FIX: Specific height for chat box */
  .chat-box { height: 600px; display: flex; flex-direction: column; }
  
  .header { padding: 1.2rem; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; background: rgba(255,255,255,0.8); }
  .avatar { width: 40px; height: 40px; background: #EEF2FF; border-radius: 50%; display: grid; place-items: center; }
  .status { font-size: 0.8rem; color: var(--success); font-weight: 600; }
  .header h3 { margin: 0; font-size: 1rem; }
  
  .history { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; background: #F8FAFC; }
  .msg { padding: 12px 16px; border-radius: 16px; max-width: 85%; font-size: 0.95rem; animation: fadeIn 0.3s ease; }
  .ai { background: #fff; border: 1px solid var(--border); border-bottom-left-radius: 4px; }
  .user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
  
  .chips { padding: 0 1rem 1rem; display: flex; gap: 8px; }
  .chip { background: #fff; border: 1px solid var(--border); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: 0.2s; }
  .chip:hover { border-color: var(--primary); color: var(--primary); background: #EEF2FF; }

  .input-area { padding: 1rem; border-top: 1px solid var(--border); display: flex; gap: 10px; background: #fff; }
  input { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 10px; outline: none; transition: 0.2s; }
  input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
  #send-btn { background: var(--primary); color: white; border: none; padding: 0 20px; border-radius: 10px; font-weight: 600; cursor: pointer; }
  #send-btn:disabled { opacity: 0.6; }
</style>

<script>
  import { api } from '../utils/api.js';

  // üî• DEMO DATA (Hackathon Safety)
  const DEMO = {
    'macbook': { productName: "MacBook Pro M3", category: "Electronics", price: 1499, targetMembers: 5 },
    'iphone': { productName: "iPhone 15 Pro", category: "Mobile", price: 999, targetMembers: 10 }
  };

  const input = document.getElementById('chat-input');
  const btn = document.getElementById('send-btn');
  const history = document.getElementById('chat-history');
  const typing = document.getElementById('typing');
  let messages = [];

  async function sendMessage(text) {
    if (!text) return;
    appendMsg(text, 'user');
    input.value = '';
    btn.disabled = true;
    typing.style.display = 'flex';
    history.scrollTop = history.scrollHeight;
    
    try {
      const res = await api.post('/ai/chat', { message: text, address: 'guest', context: messages.slice(-5) });
      typing.style.display = 'none';
      appendMsg(res.data.response, 'ai');
      if (res.data.deal) window.dispatchEvent(new CustomEvent('deal-found', { detail: res.data.deal }));
    } catch (e) {
      // FALLBACK
      typing.style.display = 'none';
      const lower = text.toLowerCase();
      const fallback = lower.includes('macbook') ? DEMO['macbook'] : (lower.includes('iphone') ? DEMO['iphone'] : null);
      
      if (fallback) {
        appendMsg(`üöÄ (Demo Mode) Found a live deal for ${fallback.productName}!`, 'ai');
        window.dispatchEvent(new CustomEvent('deal-found', { detail: fallback }));
      } else {
        appendMsg("ü§ñ AI is connecting... Click a chip to simulate a deal!", 'ai');
      }
    } finally {
      btn.disabled = false;
      input.focus();
    }
  }

  function appendMsg(text, role) {
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    div.innerHTML = text;
    history.appendChild(div);
    history.scrollTop = history.scrollHeight;
    messages.push({ role, content: text });
  }

  btn.onclick = () => sendMessage(input.value.trim());
  input.onkeypress = (e) => e.key === 'Enter' && sendMessage(input.value.trim());
  document.querySelectorAll('.chip').forEach(c => c.onclick = (e) => sendMessage(e.target.dataset.q));
</script>
